import 'package:flutter/material.dart';
import 'package:ugo_driver/constants/app_colors.dart';
import 'package:ugo_driver/constants/responsive.dart';
import 'package:geolocator/geolocator.dart';
import 'package:ugo_driver/flutter_flow/flutter_flow_util.dart';
import 'package:ugo_driver/services/location_geocode_service.dart';
import 'package:ugo_driver/services/route_distance_service.dart';
import '../home/ride_request_model.dart';

class NewRequestCard extends StatelessWidget {
  final RideRequest ride;
  final int remainingTime;
  final VoidCallback? onAccept;
  final VoidCallback? onDecline;
  final LatLng? driverLocation;
  final bool isLoading;

  const NewRequestCard({
    super.key,
    required this.ride,
    required this.remainingTime,
    this.onAccept,
    this.onDecline,
    this.driverLocation,
    this.isLoading = false,
  });

  // --- Colors ---
  static const Color ugoOrange = AppColors.primary;
  static const Color ugoGreen = AppColors.success;
  static const Color ugoRed = AppColors.error;
  static const Color ugoBlue = AppColors.infoDark;

  /// Compute pickup distance from driver to pickup (km).
  static double? _pickupDistanceKm(LatLng? driver, RideRequest ride) {
    if (driver == null || ride.pickupLat == 0 || ride.pickupLng == 0) {
      return null;
    }
    final m = Geolocator.distanceBetween(
      driver.latitude,
      driver.longitude,
      ride.pickupLat,
      ride.pickupLng,
    );
    return m / 1000;
  }

  /// Compute drop distance from pickup to drop (km).
  static double? _dropDistanceKm(RideRequest ride) {
    if (ride.pickupLat == 0 ||
        ride.pickupLng == 0 ||
        ride.dropLat == 0 ||
        ride.dropLng == 0) {
      return null;
    }
    final m = Geolocator.distanceBetween(
      ride.pickupLat,
      ride.pickupLng,
      ride.dropLat,
      ride.dropLng,
    );
    return m / 1000;
  }

  static String _formatDistance(double? km) {
    if (km == null) {
      return '--';
    }
    return km < 1 ? '${(km * 1000).round()}m' : '${km.toStringAsFixed(1)}Km';
  }

  @override
  Widget build(BuildContext context) {
    final margin =
        Responsive.value(context, small: 8.0, medium: 10.0, large: 12.0);
    final pad = Responsive.horizontalPadding(context);
    final isNarrow = MediaQuery.sizeOf(context).width < 360;
    final pickupKm = _pickupDistanceKm(driverLocation, ride);
    final pickupDistStr = _formatDistance(pickupKm);
    return Container(
      margin: EdgeInsets.all(margin),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(20),
        boxShadow: const [
          BoxShadow(color: Colors.black26, blurRadius: 10, offset: Offset(0, 4))
        ],
        border: Border.all(color: ugoOrange, width: 2),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Container(
            padding: EdgeInsets.symmetric(
                horizontal: pad, vertical: Responsive.verticalSpacing(context)),
            decoration: const BoxDecoration(
                color: ugoGreen,
                borderRadius: BorderRadius.vertical(top: Radius.circular(18))),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(FFLocalizations.of(context).getText('drv_new_request'),
                    style: TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontSize: Responsive.fontSize(context, 16))),
                Text('${remainingTime}s',
                    style: TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontSize: Responsive.fontSize(context, 16))),
              ],
            ),
          ),
          Padding(
            padding: EdgeInsets.all(pad),
            child: Column(
              children: [
                if (isNarrow)
                  Column(
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          _buildDistanceInfo(
                            context,
                            FFLocalizations.of(context)
                                .getText('drv_pickup_distance'),
                            pickupDistStr,
                          ),
                          _buildDropDistanceInfo(
                            context,
                            FFLocalizations.of(context)
                                .getText('drv_drop_distance'),
                            ride,
                          ),
                        ],
                      ),
                      SizedBox(
                          height: MediaQuery.sizeOf(context).height * 0.015),
                      _buildFareBox(context),
                    ],
                  )
                else
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      _buildDistanceInfo(
                        context,
                        FFLocalizations.of(context)
                            .getText('drv_pickup_distance'),
                        pickupDistStr,
                      ),
                      Expanded(child: _buildFareBox(context)),
                      _buildDropDistanceInfo(
                        context,
                        FFLocalizations.of(context)
                            .getText('drv_drop_distance'),
                        ride,
                      ),
                    ],
                  ),
                SizedBox(height: MediaQuery.sizeOf(context).height * 0.025),
                _AddressRowFromLatLng(
                  lat: ride.dropLat,
                  lng: ride.dropLng,
                  address: ride.dropAddress,
                  color: ugoRed,
                  label: FFLocalizations.of(context).getText('drv_drop'),
                ),
                SizedBox(height: Responsive.verticalSpacing(context)),
                _AddressRowFromLatLng(
                  lat: ride.pickupLat,
                  lng: ride.pickupLng,
                  address: ride.pickupAddress,
                  color: ugoGreen,
                  label: FFLocalizations.of(context).getText('drv_pickup'),
                ),
                SizedBox(height: MediaQuery.sizeOf(context).height * 0.025),
                Row(
                  children: [
                    Expanded(
                        flex: 3,
                        child: _buildButton(
                            context,
                            FFLocalizations.of(context).getText('drv_decline'),
                            ugoRed,
                            isLoading ? null : onDecline)),
                    SizedBox(width: MediaQuery.sizeOf(context).width * 0.04),
                    Expanded(
                        flex: 7,
                        child: isLoading
                            ? Center(
                                child: Padding(
                                  padding: EdgeInsets.all(
                                      MediaQuery.sizeOf(context).width * 0.03),
                                  child: SizedBox(
<<<<<<< Updated upstream
                                    width: MediaQuery.sizeOf(context).width * 0.06,
                                    height: MediaQuery.sizeOf(context).width * 0.06,
                                    child: const CircularProgressIndicator(
=======
                                    width:
                                        MediaQuery.sizeOf(context).width * 0.06,
                                    height:
                                        MediaQuery.sizeOf(context).width * 0.06,
                                    child: CircularProgressIndicator(
>>>>>>> Stashed changes
                                      strokeWidth: 2,
                                      color: ugoGreen,
                                    ),
                                  ),
                                ),
                              )
                            : _buildButton(
                                context,
                                FFLocalizations.of(context)
                                    .getText('drv_accept'),
                                ugoGreen,
                                onAccept)),
                  ],
                )
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildDistanceInfo(BuildContext context, String label, String value,
      {bool alignRight = false}) {
    return Column(
        crossAxisAlignment:
            alignRight ? CrossAxisAlignment.end : CrossAxisAlignment.start,
        children: [
          Text(label,
              style: TextStyle(
                  color: Colors.grey[400],
                  fontSize: Responsive.fontSize(context, 12))),
          Text(value,
              style: TextStyle(
                  color: ugoBlue,
                  fontSize: Responsive.fontSize(context, 20),
                  fontWeight: FontWeight.bold))
        ]);
  }

  Widget _buildFareBox(BuildContext context) {
    return Stack(
      alignment: Alignment.center,
      children: [
        Container(height: 1, color: Colors.grey[300]),
        const Icon(Icons.arrow_forward, size: 16),
        Padding(
          padding:
              EdgeInsets.only(bottom: MediaQuery.sizeOf(context).height * 0.03),
          child: Container(
            padding: EdgeInsets.symmetric(
              horizontal: MediaQuery.sizeOf(context).width * 0.03,
              vertical: MediaQuery.sizeOf(context).height * 0.01,
            ),
            decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: Colors.grey[400]!)),
            child: Column(children: [
              Text(FFLocalizations.of(context).getText('ride0006'),
                  style: TextStyle(color: Colors.grey[400], fontSize: 10)),
              Text('â‚¹${ride.estimatedFare?.toInt() ?? 80}',
                  style: const TextStyle(
                      color: ugoBlue,
                      fontSize: 18,
                      fontWeight: FontWeight.bold)),
            ]),
          ),
        ),
      ],
    );
  }

  Widget _buildDropDistanceInfo(
    BuildContext context,
    String label,
    RideRequest ride,
  ) {
    final fallbackKm = _dropDistanceKm(ride);
    return FutureBuilder<double?>(
      future: RouteDistanceService().getDrivingDistanceKm(
        originLat: ride.pickupLat,
        originLng: ride.pickupLng,
        destLat: ride.dropLat,
        destLng: ride.dropLng,
      ),
      builder: (context, snapshot) {
        final km = snapshot.data ?? fallbackKm;
        return _buildDistanceInfo(context, label, _formatDistance(km),
            alignRight: true);
      },
    );
  }

  Widget _buildButton(
      BuildContext context, String text, Color bg, VoidCallback? onTap) {
    final btnH = Responsive.buttonHeight(context, base: 48);
    return SizedBox(
      height: btnH,
      child: ElevatedButton(
        onPressed: onTap,
        style: ElevatedButton.styleFrom(
          backgroundColor: bg,
          padding: const EdgeInsets.symmetric(vertical: 14),
          shape:
              RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        ),
        child: Text(
          text,
          style: TextStyle(
            color: Colors.white,
            fontWeight: FontWeight.bold,
            fontSize: Responsive.fontSize(context, 15),
          ),
        ),
      ),
    );
  }
}

/// Rapido-style: area name highlighted with entrance animations.
class _AddressRowFromLatLng extends StatefulWidget {
  final double lat;
  final double lng;
  final String address;
  final Color color;
  final String label;

  const _AddressRowFromLatLng({
    required this.lat,
    required this.lng,
    required this.address,
    required this.color,
    required this.label,
  });

  @override
  State<_AddressRowFromLatLng> createState() => _AddressRowFromLatLngState();
}

class _AddressRowFromLatLngState extends State<_AddressRowFromLatLng>
    with SingleTickerProviderStateMixin {
  late AnimationController _animController;
  late Animation<double> _fadeAnim;
  late Animation<Offset> _slideAnim;

  @override
  void initState() {
    super.initState();
    _animController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 450),
    );
    _fadeAnim = Tween<double>(begin: 0, end: 1).animate(
      CurvedAnimation(parent: _animController, curve: Curves.easeOut),
    );
    _slideAnim = Tween<Offset>(
      begin: const Offset(0, 0.15),
      end: Offset.zero,
    ).animate(
        CurvedAnimation(parent: _animController, curve: Curves.easeOutCubic));
  }

  @override
  void dispose() {
    _animController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final boxSz =
        Responsive.value(context, small: 42.0, medium: 45.0, large: 48.0);
    return FutureBuilder(
      future: (widget.lat != 0 || widget.lng != 0)
          ? LocationGeocodeService()
              .getPincodeAndLocality(widget.lat, widget.lng)
          : Future.value((pincode: '', locality: '')),
      builder: (context, snapshot) {
        final code = snapshot.data?.pincode ?? '';
        final locality = snapshot.data?.locality ?? '';
        final areaName = locality.isNotEmpty
            ? locality
            : widget.address.split(',').firstOrNull?.trim() ?? widget.address;
        if (snapshot.hasData &&
            !_animController.isAnimating &&
            !_animController.isCompleted) {
          WidgetsBinding.instance
              .addPostFrameCallback((_) => _animController.forward());
        }
        return Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Container(
              width: boxSz,
              height: boxSz,
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: widget.color.withValues(alpha: 0.5)),
              ),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Icons.location_on,
                      color: widget.color,
                      size: Responsive.iconSize(context, base: 20)),
                  Text(
                    widget.label,
                    style: TextStyle(
                        fontSize: Responsive.fontSize(context, 10),
                        color: Colors.grey),
                  ),
                ],
              ),
            ),
            SizedBox(width: Responsive.verticalSpacing(context)),
            Expanded(
              child: FadeTransition(
                opacity: _fadeAnim,
                child: SlideTransition(
                  position: _slideAnim,
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      if (code.isNotEmpty)
                        Text(
                          code,
                          style: TextStyle(
                            color: NewRequestCard.ugoOrange,
                            fontWeight: FontWeight.bold,
                            fontSize: Responsive.fontSize(context, 13),
                            letterSpacing: 0.5,
                          ),
                        ),
                      const SizedBox(height: 6),
                      _HighlightedAreaChip(
                        areaName: areaName,
                        color: widget.color,
                      ),
                      const SizedBox(height: 6),
                      Text(
                        widget.address,
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                        style: TextStyle(
                          color: Colors.grey[700],
                          fontSize: Responsive.fontSize(context, 12),
                          height: 1.3,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ],
        );
      },
    );
  }
}

/// Rapido-style highlighted area chip with pulse animation.
class _HighlightedAreaChip extends StatefulWidget {
  final String areaName;
  final Color color;

  const _HighlightedAreaChip({
    required this.areaName,
    required this.color,
  });

  @override
  State<_HighlightedAreaChip> createState() => _HighlightedAreaChipState();
}

class _HighlightedAreaChipState extends State<_HighlightedAreaChip>
    with SingleTickerProviderStateMixin {
  late AnimationController _pulseController;
  late Animation<double> _pulseAnim;

  @override
  void initState() {
    super.initState();
    _pulseController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1800),
    )..repeat(reverse: true);
    _pulseAnim = Tween<double>(begin: 0.85, end: 1.0).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );
  }

  @override
  void dispose() {
    _pulseController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return ScaleTransition(
      scale: _pulseAnim,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 300),
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        decoration: BoxDecoration(
          color: widget.color.withValues(alpha: 0.15),
          borderRadius: BorderRadius.circular(10),
          border: Border.all(
              color: widget.color.withValues(alpha: 0.5), width: 1.5),
          boxShadow: [
            BoxShadow(
              color: widget.color.withValues(alpha: 0.2),
              blurRadius: 8,
              offset: const Offset(0, 2),
            ),
          ],
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(Icons.place, color: widget.color, size: 18),
            const SizedBox(width: 6),
            Flexible(
              child: Text(
                widget.areaName,
                maxLines: 1,
                overflow: TextOverflow.ellipsis,
                style: TextStyle(
                  color: widget.color,
                  fontWeight: FontWeight.w800,
                  fontSize: Responsive.fontSize(context, 15),
                  letterSpacing: 0.3,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
